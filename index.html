<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <title>è´ªåƒè›‡æ¸¸æˆ</title>
    <style>
        body {
            min-height: 100vh;
            margin: 0;
            background: #f4f4f4;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        .container {
            background: #fff;
            border-radius: 16px;
            box-shadow: 0 4px 24px rgba(0,0,0,0.08);
            padding: 40px 32px 32px 32px;
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative;
        }
        .sound-button {
            position: absolute;
            top: 24px;
            right: 32px;
            background: #4CAF50;
            color: #fff;
            border: none;
            border-radius: 6px;
            padding: 8px 18px;
            font-size: 1rem;
            cursor: pointer;
            transition: background 0.2s;
        }
        .sound-button.muted {
            background: #f44336;
        }
        .sound-button:hover {
            background: #388e3c;
        }
        .sound-button.muted:hover {
            background: #c62828;
        }
        .title {
            font-size: 2.2rem;
            font-weight: bold;
            letter-spacing: 2px;
            color: #222;
            margin-bottom: 8px;
        }
        .score {
            font-size: 1.3rem;
            color: #333;
            margin-bottom: 18px;
            font-weight: 500;
        }
        #gameCanvas {
            border: 2px solid #333;
            background: #fafafa;
            margin-bottom: 24px;
            display: block;
        }
        .controls {
            display: flex;
            gap: 16px;
            margin-bottom: 18px;
        }
        .controls button {
            padding: 10px 24px;
            font-size: 1rem;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            background: #4CAF50;
            color: #fff;
            font-weight: 500;
            transition: background 0.2s;
        }
        .controls button:hover {
            background: #388e3c;
        }
        .controls button#pauseBtn {
            background: #eee;
            color: #333;
        }
        .controls button#pauseBtn:hover {
            background: #ccc;
        }
        .speed-controls {
            display: flex;
            gap: 12px;
            margin-bottom: 0;
        }
        .speed-btn {
            padding: 8px 20px;
            font-size: 1rem;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            background: #eee;
            color: #333;
            font-weight: 500;
            transition: background 0.2s, color 0.2s;
        }
        .speed-btn.active {
            background: #4CAF50;
            color: #fff;
        }
        @media (max-width: 600px) {
            .container {
                padding: 16px 4px 16px 4px;
            }
            #gameCanvas {
                width: 90vw;
                height: 90vw;
                max-width: 350px;
                max-height: 350px;
            }
            .sound-button {
                right: 8px;
                top: 8px;
                padding: 6px 10px;
                font-size: 0.9rem;
            }
        }
        .countdown-overlay {
            position: absolute;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(255,255,255,0.7);
            z-index: 10;
        }
        .countdown-circle {
            position: relative;
            width: 160px;
            height: 160px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .countdown-number {
            position: absolute;
            left: 0; right: 0; top: 0; bottom: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 80px;
            font-weight: bold;
            color: #222;
        }
    </style>
</head>
<body>
    <div class="container">
        <button id="soundBtn" class="sound-button">ğŸ”Š éŸ³æ•ˆ</button>
        <div class="title">è´ªåƒè›‡</div>
        <div class="score" id="score">åˆ†æ•°: 0</div>
        <div style="position:relative;">
            <canvas id="gameCanvas" width="400" height="400"></canvas>
            <div id="countdownOverlay" class="countdown-overlay" style="display:none;">
                <div class="countdown-circle">
                    <svg width="160" height="160">
                        <circle cx="80" cy="80" r="70" stroke="#ddd" stroke-width="14" fill="none"/>
                        <circle id="countdownArc" cx="80" cy="80" r="70" stroke="#4CAF50" stroke-width="14" fill="none" stroke-linecap="round" stroke-dasharray="439.6" stroke-dashoffset="0"/>
                    </svg>
                    <div class="countdown-number" id="countdownNumber">3</div>
                </div>
            </div>
        </div>
        <div class="controls">
            <button id="startBtn">å¼€å§‹æ¸¸æˆ</button>
            <button id="pauseBtn">æš‚åœ</button>
        </div>
        <div class="speed-controls">
            <button class="speed-btn active" data-speed="slow">æ…¢é€Ÿ</button>
            <button class="speed-btn" data-speed="medium">ä¸­é€Ÿ</button>
            <button class="speed-btn" data-speed="fast">å¿«é€Ÿ</button>
        </div>
    </div>

    <script>
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const gridSize = 20;
        const tileCount = canvas.width / gridSize;
        
        let snake = [];
        let food = {};
        let currentDirection = 'right';
        let isGameRunning = false;
        let score = 0;
        let gameSpeed = 150; // åˆå§‹é€Ÿåº¦
        let speedLevel = 'slow';
        let hasShownSpeedPrompt = false;
        let isSoundEnabled = true;
        let audioContext = null;
        let oscillator = null;
        let gainNode = null;

        // åˆå§‹åŒ–æ¸¸æˆ
        function initGame() {
            // åˆå§‹åŒ–è›‡çš„ä½ç½®
            snake = [
                {x: 5, y: 5},
                {x: 4, y: 5},
                {x: 3, y: 5}
            ];
            
            // åˆå§‹åŒ–æ–¹å‘
            currentDirection = 'right';
            
            // é‡ç½®åˆ†æ•°
            score = 0;
            document.getElementById('score').textContent = `åˆ†æ•°: ${score}`;
            
            // ç”Ÿæˆç¬¬ä¸€ä¸ªé£Ÿç‰©
            generateFood();
            
            // é‡ç½®é€Ÿåº¦æç¤ºæ ‡å¿—
            hasShownSpeedPrompt = false;
            
            // å¼€å§‹æ¸¸æˆ
            isGameRunning = true;
            gameLoop();
        }

        // ç”Ÿæˆé£Ÿç‰©
        function generateFood() {
            food = {
                x: Math.floor(Math.random() * tileCount),
                y: Math.floor(Math.random() * tileCount)
            };
            
            // ç¡®ä¿é£Ÿç‰©ä¸ä¼šç”Ÿæˆåœ¨è›‡èº«ä¸Š
            while (snake.some(segment => segment.x === food.x && segment.y === food.y)) {
                food = {
                    x: Math.floor(Math.random() * tileCount),
                    y: Math.floor(Math.random() * tileCount)
                };
            }
        }

        // ç»˜åˆ¶æ¸¸æˆç”»é¢
        function drawGame() {
            // æ¸…ç©ºç”»å¸ƒ
            ctx.fillStyle = 'white';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            // ç»˜åˆ¶è›‡
            ctx.fillStyle = '#4CAF50';
            snake.forEach(segment => {
                ctx.fillRect(segment.x * gridSize, segment.y * gridSize, gridSize - 2, gridSize - 2);
            });
            
            // ç»˜åˆ¶é£Ÿç‰©
            ctx.fillStyle = 'red';
            ctx.fillRect(food.x * gridSize, food.y * gridSize, gridSize - 2, gridSize - 2);
        }

        // æ¸¸æˆç»“æŸ
        function gameOver() {
            isGameRunning = false;
            playSound('gameOver');
            alert(`æ¸¸æˆç»“æŸï¼å¾—åˆ†ï¼š${score}`);
        }

        // æ›´æ–°é€Ÿåº¦
        function updateSpeed() {
            switch(speedLevel) {
                case 'slow':
                    gameSpeed = 150;
                    break;
                case 'medium':
                    gameSpeed = 100;
                    break;
                case 'fast':
                    gameSpeed = 50;
                    break;
            }
        }

        // æ›¿æ¢å€’è®¡æ—¶å‡½æ•°
        function startCountdown(callback) {
            const overlay = document.getElementById('countdownOverlay');
            const number = document.getElementById('countdownNumber');
            const arc = document.getElementById('countdownArc');
            overlay.style.display = 'flex';
            let count = 3;
            let total = 3;
            let start = Date.now();
            let arcLen = 439.6; // 2 * Math.PI * 70

            function update() {
                let elapsed = (Date.now() - start) / 1000;
                let remain = Math.ceil(total - elapsed);
                if (remain < 1) remain = 1;
                number.textContent = remain;
                // ç¯å½¢è¿›åº¦
                let percent = Math.max(0, 1 - elapsed / total);
                arc.setAttribute('stroke-dashoffset', arcLen * percent);
                if (elapsed < total) {
                    requestAnimationFrame(update);
                } else {
                    overlay.style.display = 'none';
                    arc.setAttribute('stroke-dashoffset', 0);
                    callback();
                }
            }
            update();
        }

        // éŸ³æ•ˆæ§åˆ¶å‡½æ•°
        function toggleSound() {
            isSoundEnabled = !isSoundEnabled;
            const soundBtn = document.getElementById('soundBtn');
            soundBtn.textContent = isSoundEnabled ? 'ğŸ”Š éŸ³æ•ˆ' : 'ğŸ”‡ éŸ³æ•ˆ';
            soundBtn.classList.toggle('muted');
        }

        // æ’­æ”¾éŸ³æ•ˆå‡½æ•°
        function playSound(type) {
            if (!isSoundEnabled || !audioContext) return;

            try {
                // å¦‚æœå·²ç»æœ‰æ­£åœ¨æ’­æ”¾çš„éŸ³æ•ˆï¼Œå…ˆåœæ­¢å®ƒ
                if (oscillator) {
                    oscillator.stop();
                }

                // åˆ›å»ºæ–°çš„æŒ¯è¡å™¨
                oscillator = audioContext.createOscillator();
                oscillator.connect(gainNode);

                // æ ¹æ®ä¸åŒç±»å‹è®¾ç½®ä¸åŒçš„éŸ³æ•ˆ
                switch(type) {
                    case 'eat':
                        oscillator.type = 'sine';
                        oscillator.frequency.setValueAtTime(880, audioContext.currentTime); // A5
                        break;
                    case 'gameOver':
                        oscillator.type = 'sawtooth';
                        oscillator.frequency.setValueAtTime(220, audioContext.currentTime); // A3
                        break;
                    case 'upgrade':
                        oscillator.type = 'square';
                        oscillator.frequency.setValueAtTime(440, audioContext.currentTime); // A4
                        break;
                }

                oscillator.start();
                oscillator.stop(audioContext.currentTime + 0.1); // æ’­æ”¾0.1ç§’
            } catch (error) {
                console.log('éŸ³æ•ˆæ’­æ”¾å¤±è´¥:', error);
            }
        }

        // æ¸¸æˆä¸»å¾ªç¯
        function gameLoop() {
            if (!isGameRunning) return;
            
            const head = snake[0];
            let newHead = { x: head.x, y: head.y };

            // æ ¹æ®å½“å‰æ–¹å‘ç§»åŠ¨è›‡å¤´
            switch (currentDirection) {
                case 'up': newHead.y--; break;
                case 'down': newHead.y++; break;
                case 'left': newHead.x--; break;
                case 'right': newHead.x++; break;
            }

            // æ£€æŸ¥æ˜¯å¦æ’å¢™æˆ–æ’åˆ°è‡ªå·±
            if (newHead.x < 0 || newHead.x >= tileCount || 
                newHead.y < 0 || newHead.y >= tileCount ||
                snake.some(segment => segment.x === newHead.x && segment.y === newHead.y)) {
                gameOver();
                return;
            }

            // å°†æ–°å¤´éƒ¨æ·»åŠ åˆ°è›‡èº«æ•°ç»„çš„å¼€å¤´
            snake.unshift(newHead);

            // æ£€æŸ¥æ˜¯å¦åƒåˆ°é£Ÿç‰©
            if (newHead.x === food.x && newHead.y === food.y) {
                score += 10;
                document.getElementById('score').textContent = `åˆ†æ•°: ${score}`;
                generateFood();
                playSound('eat');
                
                // æ£€æŸ¥æ˜¯å¦éœ€è¦æç¤ºå‡çº§
                if (score === 50 && !hasShownSpeedPrompt) {
                    hasShownSpeedPrompt = true;
                    isGameRunning = false;
                    if (confirm('æ­å–œè¾¾åˆ°50åˆ†ï¼æ˜¯å¦è¦æé«˜é€Ÿåº¦ï¼Ÿ')) {
                        startCountdown(() => {
                            speedLevel = 'medium';
                            updateSpeed();
                            document.querySelector('[data-speed="medium"]').classList.add('active');
                            document.querySelector('[data-speed="slow"]').classList.remove('active');
                            isGameRunning = true;
                            requestAnimationFrame(gameLoop);
                        });
                    } else {
                        startCountdown(() => {
                            isGameRunning = true;
                            requestAnimationFrame(gameLoop);
                        });
                    }
                }
            } else {
                // å¦‚æœæ²¡æœ‰åƒåˆ°é£Ÿç‰©ï¼Œç§»é™¤è›‡å°¾
                snake.pop();
            }

            // ç»˜åˆ¶æ¸¸æˆç”»é¢
            drawGame();

            // ç»§ç»­æ¸¸æˆå¾ªç¯
            setTimeout(() => requestAnimationFrame(gameLoop), gameSpeed);
        }

        // é”®ç›˜æ§åˆ¶
        document.addEventListener('keydown', (event) => {
            if (!isGameRunning) return;
            
            switch(event.key) {
                case 'ArrowUp':
                    if (currentDirection !== 'down') currentDirection = 'up';
                    break;
                case 'ArrowDown':
                    if (currentDirection !== 'up') currentDirection = 'down';
                    break;
                case 'ArrowLeft':
                    if (currentDirection !== 'right') currentDirection = 'left';
                    break;
                case 'ArrowRight':
                    if (currentDirection !== 'left') currentDirection = 'right';
                    break;
            }
        });

        // é€Ÿåº¦æ§åˆ¶æŒ‰é’®äº‹ä»¶
        document.querySelectorAll('.speed-btn').forEach(button => {
            button.addEventListener('click', () => {
                if (!isGameRunning) {
                    document.querySelectorAll('.speed-btn').forEach(btn => btn.classList.remove('active'));
                    button.classList.add('active');
                    speedLevel = button.dataset.speed;
                    updateSpeed();
                }
            });
        });

        // å¼€å§‹æŒ‰é’®äº‹ä»¶
        document.getElementById('startBtn').addEventListener('click', () => {
            if (!audioContext) {
                initAudio();
            }
            initGame();
        });

        // åˆå§‹åŒ–éŸ³æ•ˆæŒ‰é’®
        document.getElementById('soundBtn').addEventListener('click', () => {
            if (!audioContext) {
                initAudio();
            }
            toggleSound();
        });

        // åˆå§‹åŒ–éŸ³é¢‘ä¸Šä¸‹æ–‡
        function initAudio() {
            try {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                gainNode = audioContext.createGain();
                gainNode.connect(audioContext.destination);
                gainNode.gain.value = 0.1; // è®¾ç½®éŸ³é‡ä¸º10%
            } catch (error) {
                console.log('éŸ³é¢‘åˆå§‹åŒ–å¤±è´¥:', error);
            }
        }
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <title>Ë¥™ÂêÉËõáÊ∏∏Êàè</title>
    <style>
        body {
            min-height: 100vh;
            margin: 0;
            background: #f4f4f4;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        .container {
            background: #fff;
            border-radius: 16px;
            box-shadow: 0 4px 24px rgba(0,0,0,0.08);
            padding: 40px 32px 32px 32px;
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative;
        }
        .sound-button {
            position: absolute;
            top: 24px;
            right: 32px;
            background: #4CAF50;
            color: #fff;
            border: none;
            border-radius: 6px;
            padding: 8px 18px;
            font-size: 1rem;
            cursor: pointer;
            transition: background 0.2s;
        }
        .sound-button.muted {
            background: #f44336;
        }
        .sound-button:hover {
            background: #388e3c;
        }
        .sound-button.muted:hover {
            background: #c62828;
        }
        .title {
            font-size: 2.2rem;
            font-weight: bold;
            letter-spacing: 2px;
            color: #222;
            margin-bottom: 8px;
        }
        .score {
            font-size: 1.3rem;
            color: #333;
            margin-bottom: 18px;
            font-weight: 500;
        }
        #gameCanvas {
            border: 2px solid #333;
            background: #fafafa;
            margin-bottom: 24px;
            display: block;
        }
        .controls {
            display: flex;
            gap: 16px;
            margin-bottom: 18px;
        }
        .controls button {
            padding: 10px 24px;
            font-size: 1rem;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            background: #4CAF50;
            color: #fff;
            font-weight: 500;
            transition: background 0.2s;
        }
        .controls button:hover {
            background: #388e3c;
        }
        .controls button#pauseBtn {
            background: #eee;
            color: #333;
        }
        .controls button#pauseBtn:hover {
            background: #ccc;
        }
        .speed-controls {
            display: flex;
            gap: 12px;
            margin-bottom: 0;
        }
        .speed-btn {
            padding: 8px 20px;
            font-size: 1rem;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            background: #eee;
            color: #333;
            font-weight: 500;
            transition: background 0.2s, color 0.2s;
        }
        .speed-btn.active {
            background: #4CAF50;
            color: #fff;
        }
        @media (max-width: 600px) {
            .container {
                padding: 16px 4px 16px 4px;
            }
            #gameCanvas {
                width: 90vw;
                height: 90vw;
                max-width: 350px;
                max-height: 350px;
            }
            .sound-button {
                right: 8px;
                top: 8px;
                padding: 6px 10px;
                font-size: 0.9rem;
            }
        }
        .countdown-overlay {
            position: absolute;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(255,255,255,0.7);
            z-index: 10;
        }
        .countdown-circle {
            position: relative;
            width: 160px;
            height: 160px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .countdown-number {
            position: absolute;
            left: 0; right: 0; top: 0; bottom: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 80px;
            font-weight: bold;
            color: #222;
        }
    </style>
</head>
<body>
    <div class="container">
        <button id="soundBtn" class="sound-button">üîä Èü≥Êïà</button>
        <div class="title">Ë¥™ÂêÉËõá</div>
        <div class="score" id="score">ÂàÜÊï∞: 0</div>
        <div style="position:relative;">
            <canvas id="gameCanvas" width="400" height="400"></canvas>
            <div id="countdownOverlay" class="countdown-overlay" style="display:none;">
                <div class="countdown-circle">
                    <svg width="160" height="160">
                        <circle cx="80" cy="80" r="70" stroke="#ddd" stroke-width="14" fill="none"/>
                        <circle id="countdownArc" cx="80" cy="80" r="70" stroke="#4CAF50" stroke-width="14" fill="none" stroke-linecap="round" stroke-dasharray="439.6" stroke-dashoffset="0"/>
                    </svg>
                    <div class="countdown-number" id="countdownNumber">3</div>
                </div>
            </div>
        </div>
        <div class="controls">
            <button id="startBtn">ÂºÄÂßãÊ∏∏Êàè</button>
            <button id="pauseBtn">ÊöÇÂÅú</button>
        </div>
        <div class="speed-controls">
            <button class="speed-btn active" data-speed="slow">ÊÖ¢ÈÄü</button>
            <button class="speed-btn" data-speed="medium">‰∏≠ÈÄü</button>
            <button class="speed-btn" data-speed="fast">Âø´ÈÄü</button>
        </div>
    </div>

    <script>
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const gridSize = 20;
        const tileCount = canvas.width / gridSize;
        
        let snake = [];
        let food = {};
        let currentDirection = 'right';
        let isGameRunning = false;
        let score = 0;
        let gameSpeed = 150; // ÂàùÂßãÈÄüÂ∫¶
        let speedLevel = 'slow';
        let hasShownSpeedPrompt = false;
        let isSoundEnabled = true;
        let audioContext = null;
        let oscillator = null;
        let gainNode = null;

        // ÂàùÂßãÂåñÊ∏∏Êàè
        function initGame() {
            // ÂàùÂßãÂåñËõáÁöÑ‰ΩçÁΩÆ
            snake = [
                {x: 5, y: 5},
                {x: 4, y: 5},
                {x: 3, y: 5}
            ];
            
            // ÂàùÂßãÂåñÊñπÂêë
            currentDirection = 'right';
            
            // ÈáçÁΩÆÂàÜÊï∞
            score = 0;
            document.getElementById('score').textContent = `ÂàÜÊï∞: ${score}`;
            
            // ÁîüÊàêÁ¨¨‰∏Ä‰∏™È£üÁâ©
            generateFood();
            
            // ÈáçÁΩÆÈÄüÂ∫¶ÊèêÁ§∫Ê†áÂøó
            hasShownSpeedPrompt = false;
            
            // ÂºÄÂßãÊ∏∏Êàè
            isGameRunning = true;
            gameLoop();
        }

        // ÁîüÊàêÈ£üÁâ©
        function generateFood() {
            food = {
                x: Math.floor(Math.random() * tileCount),
                y: Math.floor(Math.random() * tileCount)
            };
            
            // Á°Æ‰øùÈ£üÁâ©‰∏ç‰ºöÁîüÊàêÂú®ËõáË∫´‰∏ä
            while (snake.some(segment => segment.x === food.x && segment.y === food.y)) {
                food = {
                    x: Math.floor(Math.random() * tileCount),
                    y: Math.floor(Math.random() * tileCount)
                };
            }
        }

        // ÁªòÂà∂Ê∏∏ÊàèÁîªÈù¢
        function drawGame() {
            // Ê∏ÖÁ©∫ÁîªÂ∏É
            ctx.fillStyle = 'white';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            // ÁªòÂà∂Ëõá
            ctx.fillStyle = '#4CAF50';
            snake.forEach(segment => {
                ctx.fillRect(segment.x * gridSize, segment.y * gridSize, gridSize - 2, gridSize - 2);
            });
            
            // ÁªòÂà∂È£üÁâ©
            ctx.fillStyle = 'red';
            ctx.fillRect(food.x * gridSize, food.y * gridSize, gridSize - 2, gridSize - 2);
        }

        // Ê∏∏ÊàèÁªìÊùü
        function gameOver() {
            isGameRunning = false;
            playSound('gameOver');
            alert(`Ê∏∏ÊàèÁªìÊùüÔºÅÂæóÂàÜÔºö${score}`);
        }

        // Êõ¥Êñ∞ÈÄüÂ∫¶
        function updateSpeed() {
            switch(speedLevel) {
                case 'slow':
                    gameSpeed = 150;
                    break;
                case 'medium':
                    gameSpeed = 100;
                    break;
                case 'fast':
                    gameSpeed = 50;
                    break;
            }
        }

        // ÊõøÊç¢ÂÄíËÆ°Êó∂ÂáΩÊï∞
        function startCountdown(callback) {
            const overlay = document.getElementById('countdownOverlay');
            const number = document.getElementById('countdownNumber');
            const arc = document.getElementById('countdownArc');
            overlay.style.display = 'flex';
            let count = 3;
            let total = 3;
            let start = Date.now();
            let arcLen = 439.6; // 2 * Math.PI * 70

            function update() {
                let elapsed = (Date.now() - start) / 1000;
                let remain = Math.ceil(total - elapsed);
                if (remain < 1) remain = 1;
                number.textContent = remain;
                // ÁéØÂΩ¢ËøõÂ∫¶
                let percent = Math.max(0, 1 - elapsed / total);
                arc.setAttribute('stroke-dashoffset', arcLen * percent);
                if (elapsed < total) {
                    requestAnimationFrame(update);
                } else {
                    overlay.style.display = 'none';
                    arc.setAttribute('stroke-dashoffset', 0);
                    callback();
                }
            }
            update();
        }

        // Èü≥ÊïàÊéßÂà∂ÂáΩÊï∞
        function toggleSound() {
            isSoundEnabled = !isSoundEnabled;
            const soundBtn = document.getElementById('soundBtn');
            soundBtn.textContent = isSoundEnabled ? 'üîä Èü≥Êïà' : 'üîá Èü≥Êïà';
            soundBtn.classList.toggle('muted');
        }

        // Êí≠ÊîæÈü≥ÊïàÂáΩÊï∞
        function playSound(type) {
            if (!isSoundEnabled || !audioContext) return;

            try {
                // Â¶ÇÊûúÂ∑≤ÁªèÊúâÊ≠£Âú®Êí≠ÊîæÁöÑÈü≥ÊïàÔºåÂÖàÂÅúÊ≠¢ÂÆÉ
                if (oscillator) {
                    oscillator.stop();
                }

                // ÂàõÂª∫Êñ∞ÁöÑÊåØËç°Âô®
                oscillator = audioContext.createOscillator();
                oscillator.connect(gainNode);

                // Ê†πÊçÆ‰∏çÂêåÁ±ªÂûãËÆæÁΩÆ‰∏çÂêåÁöÑÈü≥Êïà
                switch(type) {
                    case 'eat':
                        oscillator.type = 'sine';
                        oscillator.frequency.setValueAtTime(880, audioContext.currentTime); // A5
                        break;
                    case 'gameOver':
                        oscillator.type = 'sawtooth';
                        oscillator.frequency.setValueAtTime(220, audioContext.currentTime); // A3
                        break;
                    case 'upgrade':
                        oscillator.type = 'square';
                        oscillator.frequency.setValueAtTime(440, audioContext.currentTime); // A4
                        break;
                }

                oscillator.start();
                oscillator.stop(audioContext.currentTime + 0.1); // Êí≠Êîæ0.1Áßí
            } catch (error) {
                console.log('Èü≥ÊïàÊí≠ÊîæÂ§±Ë¥•:', error);
            }
        }

        // Ê∏∏Êàè‰∏ªÂæ™ÁéØ
        function gameLoop() {
            if (!isGameRunning) return;
            
            const head = snake[0];
            let newHead = { x: head.x, y: head.y };

            // Ê†πÊçÆÂΩìÂâçÊñπÂêëÁßªÂä®ËõáÂ§¥
            switch (currentDirection) {
                case 'up': newHead.y--; break;
                case 'down': newHead.y++; break;
                case 'left': newHead.x--; break;
                case 'right': newHead.x++; break;
            }

            // Ê£ÄÊü•ÊòØÂê¶ÊíûÂ¢ôÊàñÊíûÂà∞Ëá™Â∑±
            if (newHead.x < 0 || newHead.x >= tileCount || 
                newHead.y < 0 || newHead.y >= tileCount ||
                snake.some(segment => segment.x === newHead.x && segment.y === newHead.y)) {
                gameOver();
                return;
            }

            // Â∞ÜÊñ∞Â§¥ÈÉ®Ê∑ªÂä†Âà∞ËõáË∫´Êï∞ÁªÑÁöÑÂºÄÂ§¥
            snake.unshift(newHead);

            // Ê£ÄÊü•ÊòØÂê¶ÂêÉÂà∞È£üÁâ©
            if (newHead.x === food.x && newHead.y === food.y) {
                score += 10;
                document.getElementById('score').textContent = `ÂàÜÊï∞: ${score}`;
                generateFood();
                playSound('eat');
                
                // Ê£ÄÊü•ÊòØÂê¶ÈúÄË¶ÅÊèêÁ§∫ÂçáÁ∫ß
                if (score === 50 && !hasShownSpeedPrompt) {
                    hasShownSpeedPrompt = true;
                    isGameRunning = false;
                    if (confirm('ÊÅ≠ÂñúËææÂà∞50ÂàÜÔºÅÊòØÂê¶Ë¶ÅÊèêÈ´òÈÄüÂ∫¶Ôºü')) {
                        startCountdown(() => {
                            speedLevel = 'medium';
                            updateSpeed();
                            document.querySelector('[data-speed="medium"]').classList.add('active');
                            document.querySelector('[data-speed="slow"]').classList.remove('active');
                            isGameRunning = true;
                            requestAnimationFrame(gameLoop);
                        });
                    } else {
                        startCountdown(() => {
                            isGameRunning = true;
                            requestAnimationFrame(gameLoop);
                        });
                    }
                }
            } else {
                // Â¶ÇÊûúÊ≤°ÊúâÂêÉÂà∞È£üÁâ©ÔºåÁßªÈô§ËõáÂ∞æ
                snake.pop();
            }

            // ÁªòÂà∂Ê∏∏ÊàèÁîªÈù¢
            drawGame();

            // ÁªßÁª≠Ê∏∏ÊàèÂæ™ÁéØ
            setTimeout(() => requestAnimationFrame(gameLoop), gameSpeed);
        }

        // ÈîÆÁõòÊéßÂà∂
        document.addEventListener('keydown', (event) => {
            if (!isGameRunning) return;
            
            switch(event.key) {
                case 'ArrowUp':
                    if (currentDirection !== 'down') currentDirection = 'up';
                    break;
                case 'ArrowDown':
                    if (currentDirection !== 'up') currentDirection = 'down';
                    break;
                case 'ArrowLeft':
                    if (currentDirection !== 'right') currentDirection = 'left';
                    break;
                case 'ArrowRight':
                    if (currentDirection !== 'left') currentDirection = 'right';
                    break;
            }
        });

        // ÈÄüÂ∫¶ÊéßÂà∂ÊåâÈíÆ‰∫ã‰ª∂
        document.querySelectorAll('.speed-btn').forEach(button => {
            button.addEventListener('click', () => {
                if (!isGameRunning) {
                    document.querySelectorAll('.speed-btn').forEach(btn => btn.classList.remove('active'));
                    button.classList.add('active');
                    speedLevel = button.dataset.speed;
                    updateSpeed();
                }
            });
        });

        // ÂºÄÂßãÊåâÈíÆ‰∫ã‰ª∂
        document.getElementById('startBtn').addEventListener('click', () => {
            if (!audioContext) {
                initAudio();
            }
            initGame();
        });

        // ÂàùÂßãÂåñÈü≥ÊïàÊåâÈíÆ
        document.getElementById('soundBtn').addEventListener('click', () => {
            if (!audioContext) {
                initAudio();
            }
            toggleSound();
        });

        // ÂàùÂßãÂåñÈü≥È¢ë‰∏ä‰∏ãÊñá
        function initAudio() {
            try {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                gainNode = audioContext.createGain();
                gainNode.connect(audioContext.destination);
                gainNode.gain.value = 0.1; // ËÆæÁΩÆÈü≥Èáè‰∏∫10%
            } catch (error) {
                console.log('Èü≥È¢ëÂàùÂßãÂåñÂ§±Ë¥•:', error);
            }
        }
    </script>
</body>
</html>
